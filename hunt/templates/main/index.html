{% extends 'base_with_nav.html' %}

{% load static %}
{% load link_helpers %}

{% block head %}
<link rel='stylesheet' href="{% static 'css/index.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<audio id="lose" src="{% static 'img/losing.mp3' %}"></audio>
<script>
    function checkFlag(challenge_id) {
        const input = $("#" + challenge_id);
        const submitBtn = input.siblings('.submit-btn');
        
        // Disable button during request
        submitBtn.prop('disabled', true).text('Submitting...');
        
        $.ajax({
            type: 'POST',
            url: "{% url 'main:validate_flag' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                dataType: 'json',
                challenge_id: challenge_id,
                flag: input.val(),
            },
            success: function (data) {
                if (data.result == "success") {
                    const box = $("#box" + challenge_id);
                    box.removeClass("available").addClass("completed flash-green");

                    // Remove the animation class after it finishes so it can be re-triggered if needed
                    setTimeout(() => box.removeClass("flash-green"), 1200);
                    // Get the original description from the challenge box
                    const originalDescription = $("#box" + challenge_id + " .challenge-description").last().html();
                    // Update content to show "Solved!" and the description
                    $("#box" + challenge_id + " .challenge-content").html(
                        '<p class="challenge-description">' + originalDescription + '</p>' +
                        '<div class="challenge-status-text completed">Solved!</div>'
                    );
                    // Remove the input section
                    $("#box" + challenge_id + " .challenge-input").remove();
                    
                    // Update decreasing cards if provided
                    if (data.decreasing_challenges_update) {
                        updateDecreasingChallengePoints(data.decreasing_challenges_update);
                    }
                } else if (data.result === "ratelimited") {
                    const alert = $("<div class='rate-limit-alert'>Too many attempts. Please slow down.</div>");
                    input.parent().append(alert);

                    requestAnimationFrame(() => {
                        alert.css("opacity", "1");
                    });

                    setTimeout(() => {
                        alert.css("opacity", "0");
                        setTimeout(() => alert.remove(), 400);
                    }, 2500);

                    submitBtn.prop('disabled', false).text('Submit');
                } else if (data.result === "hunt_inactive") {
                    const alert = $("<div class='hunt-inactive-alert'>" + (data.message || "The hunt has ended and submissions are no longer accepted.") + "</div>");
                    input.parent().append(alert);

                    requestAnimationFrame(() => {
                        alert.css("opacity", "1");
                    });

                    setTimeout(() => {
                        alert.css("opacity", "0");
                        setTimeout(() => alert.remove(), 400);
                    }, 4000);

                    submitBtn.prop('disabled', false).text('Submit');
                } else {
                    document.getElementById("lose").play();
                    input.addClass("error");
                    setTimeout(() => input.removeClass("error"), 500);
                    submitBtn.prop('disabled', false).text('Submit');
                }
            },
            failure: function () {
                input.addClass("error");
                setTimeout(() => input.removeClass("error"), 500);
                submitBtn.prop('disabled', false).text('Submit');
            }
        });
    }
    
    function updateDecreasingChallengePoints(challengeUpdates) {
        // Update point displays for specific challenges that are still available
        for (const [challengeId, newPoints] of Object.entries(challengeUpdates)) {
            const box = $("#box" + challengeId);
            if (box.hasClass('available')) {
                // Update the points display
                box.find('.challenge-points').first().text(newPoints + ' points');
            }
        }
    }
    
    function moveChallengeUp(challengeId, categoryId) {
        // Prevent the button click from triggering the admin-clickable functionality
        event.stopPropagation();
        
        $.ajax({
            type: 'POST',
            url: "{% url 'main:move_challenge_up' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                challenge_id: challengeId,
                category_id: categoryId,
            },
            success: function (data) {
                if (data.success) {
                    // Reload the page to show the new order
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Could not move challenge'));
                }
            },
            error: function () {
                alert('Error: Could not move challenge');
            }
        });
    }
    
    function moveChallengeDown(challengeId, categoryId) {
        // Prevent the button click from triggering the admin-clickable functionality
        event.stopPropagation();
        
        $.ajax({
            type: 'POST',
            url: "{% url 'main:move_challenge_down' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                challenge_id: challengeId,
                category_id: categoryId,
            },
            success: function (data) {
                if (data.success) {
                    // Reload the page to show the new order
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Could not move challenge'));
                }
            },
            error: function () {
                alert('Error: Could not move challenge');
            }
        });
    }
    
    // Set dark mode class on body
    $(document).ready(function() {
        {% if dark_mode %}
        document.body.classList.add('dark-mode');
        {% endif %}
        
        giveRibbons();
        $("#hoco-scores").fadeIn();
    });
</script>
<link rel='stylesheet' href="{% static 'css/overview.css' %}">
<script>
    function giveRibbons() {
        var arr = [];
        $("#hoco-scores .score-box").each(function () {
            var score = parseFloat($(this).find(".score").text());
            arr.push([$(this), score]);
        });
        arr.sort(function (a, b) {
            return b[1] - a[1];
        });
        var place = 0;
        $.each(arr, function (k, v) {
            if (k > 0 && arr[k - 1][1] != v[1]) {
                place += 1;
            }
            if (place == 0) {
                v[0].find(".corner-ribbon").addClass("gold").text("1st");
            }
            else if (place == 1) {
                v[0].find(".corner-ribbon").addClass("silver").text("2nd");
            }
            else if (place == 2) {
                v[0].find(".corner-ribbon").addClass("bronze").text("3rd");
            }
        });
    }
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".challenge-box").forEach(function (box) {
        box.addEventListener("click", function (e) {
            const adminUrl = this.getAttribute("data-admin-url");
            if (!adminUrl) return; // Only do this for admins

            // Don‚Äôt trigger if user clicked inside input or button
            if (e.target.closest("input") || e.target.closest("button") || e.target.closest("a")) {
                return;
            }

            window.location.href = adminUrl;
        });
    });
});
</script>

{% endblock %}

{% block main %}
<div class="challenge-container">
    <!-- Leaderboard -->
    <div id="hoco-scores">
        <div class="score-box">
            <div class="class">{{ data.0.0 }}</div>
            <div class="corner-ribbon"></div>
            <div class="score {% if user_graduation_year == data.0.0 %}score-spotlight{% endif %}" id="score-senior">{{ data.0.1 }}</div>
            points
        </div>
        <div class="score-box">
            <div class="class">{{ data.1.0 }}</div>
            <div class="corner-ribbon"></div>
            <span text="10h 45m 03.591s, -59¬∞ 41‚Äô 04.26"></span>
            <div class="score {% if user_graduation_year == data.1.0 %}score-spotlight{% endif %}" id="score-junior">{{ data.1.1 }}</div>
            points
        </div>
        <div class="score-box">
            <div class="class">{{ data.2.0 }}</div>
            <div class="corner-ribbon"></div>
            <div class="score {% if user_graduation_year == data.2.0 %}score-spotlight{% endif %}" id="score-sophomore">{{ data.2.1 }}</div>
            points
        </div>
        <div class="score-box">
            <div class="class">{{ data.3.0 }}</div>
            <div class="corner-ribbon"></div>
            <div class="score {% if user_graduation_year == data.3.0 %}score-spotlight{% endif %}" id="score-freshman">{{ data.3.1 }}</div>
            points
        </div>
    </div>

    <!-- Page Title -->
    <h1 class="page-title">Homecoming Scavenger Hunt {{ HUNT_YEAR }}</h1>

    <!-- Hunt Status Notice -->
    {% if not HUNT_ACTIVE and not request.user.is_committee %}
    <div class="hunt-status-banner">
        <div class="hunt-status-content">
            <h3>üèÅ The Hunt Has Ended!</h3>
            <p>Flag submissions are no longer accepted, but you can still view all challenges and final scores.</p>
        </div>
    </div>
    {% endif %}

    <!-- Categories and Challenges -->
    {% for category, challenges in categories.values %}
    <div class="category-section">
        <div class="category-header">
            <h2 class="category-title">{{ category.name }}</h2>
            <div class="category-actions">
                {% if request.user.is_staff %}
                <a href="/admin/main/challenge/add/?category={{ category.id }}" 
                   class="add-challenge-btn" 
                   title="Add new challenge to {{ category.name }}" 
                   target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Add Challenge
                </a>
                {% endif %}
                <button class="toggle-btn" 
                    onclick="document.getElementById('c-{{ category.id }}').classList.toggle('hidden')">
                    Toggle
                </button>
            </div>
        </div>
        
        {% if category.description %}
        <p class="category-description">{{ category.description }}</p>
        {% endif %}
        
        <div id="c-{{ category.id }}" class="challenges-grid">
            {% for challenge, status in challenges.items %}
            <div id="box{{ status.0.id }}" class="challenge-box {% if status.1 == 'available' %}available{% elif status.1 == 'completed' %}completed{% else %}locked{% endif %}{% if request.user.is_staff %} admin-clickable{% endif %}"
                {% if request.user.is_staff %}
                    data-admin-url="{% url 'admin:main_challenge_change' status.0.id %}"
                    title="Edit this challenge"
                {% endif %}>
                {% if request.user.is_staff %}
                    <button class="challenge-move-up-btn" onclick="moveChallengeUp({{ status.0.id }}, {{ category.id }})" title="Move up">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 17l9-10 9 10z"/>
                        </svg>
                    </button>
                    <button class="challenge-move-down-btn" onclick="moveChallengeDown({{ status.0.id }}, {{ category.id }})" title="Move down">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 7l9 10 9-10z"/>
                        </svg>
                    </button>
                {% endif %}
                <div class="challenge-header">
                    <h4 class="challenge-title">
                        {{ status.0.name }}
                    </h4>
                    {% if status.0.is_decreasing and status.1 == 'available' and status|length > 2 %}
                        <p class="challenge-points">{{ status.2 }} points</p>
                    {% else %}
                        <p class="challenge-points">{{ status.0.points }} points</p>
                    {% endif %}
                </div>
                
                <div class="challenge-content">
                    {% if not status.0.unblocked and request.user.is_staff %}
                        <p class="challenge-description">This challenge is currently unavailable.</p>
                    {% elif status.1 == 'completed' %}
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                        <div class="challenge-status-text completed">Solved!</div>
                    {% elif status.1 == 'locked' %}
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                        <p class="challenge-description">This challenge was exclusive and has already been completed by another class.</p>
                    {% elif status.0.is_exclusive %}
                        <p class="challenge-description">This challenge's points are only available to the first class to complete it.</p>
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                    {% elif status.0.is_decreasing %}
                        <p class="challenge-description">This challenge's points decrease each time a class completes it.</p>
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                    {% else %}
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                    {% endif %}
                </div>
                
                {% if status.1 == 'available' and status.0.unblocked %}
                <div class="challenge-input">
                    {% if HUNT_ACTIVE or request.user.is_committee %}
                        <input type="text" id="{{ status.0.id }}" class="flag-input" placeholder="Enter the flag here" />
                        <button type="button" class="submit-btn" onclick="checkFlag({{ status.0.id }})">Submit</button>
                    {% else %}
                        <div class="hunt-ended-message">
                            <p>The hunt has ended! Flag submissions are no longer accepted.</p>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}
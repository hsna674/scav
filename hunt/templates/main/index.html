{% extends 'base_with_nav.html' %}

{% load static %}
{% load link_helpers %}

{% block head %}
<link rel='stylesheet' href="{% static 'css/index.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<audio id="lose" src="{% static 'img/losing.mp3' %}"></audio>
<script>
    function checkFlag(challenge_id) {
        const input = $("#" + challenge_id);
        const submitBtn = input.siblings('.submit-btn');
        
        // Disable button during request
        submitBtn.prop('disabled', true).text('Submitting...');
        
        $.ajax({
            type: 'POST',
            url: "{% url 'main:validate_flag' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                dataType: 'json',
                challenge_id: challenge_id,
                flag: input.val(),
            },
            success: function (data) {
                if (data.result == "success") {
                    const box = $("#box" + challenge_id);
                    box.removeClass("available").addClass("completed flash-green");

                    // Remove the animation class after it finishes so it can be re-triggered if needed
                    setTimeout(() => box.removeClass("flash-green"), 1200);
                    // Get the original description from the challenge box
                    const originalDescription = $("#box" + challenge_id + " .challenge-description").last().html();
                    // Update content to show "Solved!" and the description
                    $("#box" + challenge_id + " .challenge-content").html(
                        '<p class="challenge-description">' + originalDescription + '</p>' +
                        '<div class="challenge-status-text completed">Solved!</div>'
                    );
                    // Remove the input section
                    $("#box" + challenge_id + " .challenge-input").remove();
                    
                    // Update decreasing cards if provided
                    if (data.decreasing_challenges_update) {
                        updateDecreasingChallengePoints(data.decreasing_challenges_update);
                    }
                } else if (data.result === "ratelimited") {
                    const alert = $("<div style='margin-top:8px; padding:6px 10px; border:1px solid #ccc; border-radius:4px; font-size:14px; color:#333; background:#f9f9f9; opacity:0; transition:opacity 0.4s;'>Too many attempts. Please slow down.</div>");
                    input.parent().append(alert);

                    requestAnimationFrame(() => {
                        alert.css("opacity", "1");
                    });

                    setTimeout(() => {
                        alert.css("opacity", "0");
                        setTimeout(() => alert.remove(), 400);
                    }, 2500);

                    submitBtn.prop('disabled', false).text('Submit');
                } else {
                    document.getElementById("lose").play();
                    input.addClass("error");
                    setTimeout(() => input.removeClass("error"), 500);
                    submitBtn.prop('disabled', false).text('Submit');
                }
            },
            failure: function () {
                input.addClass("error");
                setTimeout(() => input.removeClass("error"), 500);
                submitBtn.prop('disabled', false).text('Submit');
            }
        });
    }
    
    function updateDecreasingChallengePoints(challengeUpdates) {
        // Update point displays for specific challenges that are still available
        for (const [challengeId, newPoints] of Object.entries(challengeUpdates)) {
            const box = $("#box" + challengeId);
            if (box.hasClass('available')) {
                // Update the points display
                box.find('.challenge-points').first().text(newPoints + ' points');
            }
        }
    }
    
    // Set dark mode class on body
    $(document).ready(function() {
        {% if dark_mode %}
        document.body.classList.add('dark-mode');
        {% endif %}
        
        giveRibbons();
        $("#hoco-scores").fadeIn();
    });
</script>
<link rel='stylesheet' href="{% static 'css/overview.css' %}">
<script>
    function giveRibbons() {
        var arr = [];
        $("#hoco-scores .score-box").each(function () {
            var score = parseFloat($(this).find(".score").text());
            arr.push([$(this), score]);
        });
        arr.sort(function (a, b) {
            return b[1] - a[1];
        });
        var place = 0;
        $.each(arr, function (k, v) {
            if (k > 0 && arr[k - 1][1] != v[1]) {
                place += 1;
            }
            if (place == 0) {
                v[0].find(".corner-ribbon").addClass("gold").text("1st");
            }
            else if (place == 1) {
                v[0].find(".corner-ribbon").addClass("silver").text("2nd");
            }
            else if (place == 2) {
                v[0].find(".corner-ribbon").addClass("bronze").text("3rd");
            }
        });
    }
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".challenge-box").forEach(function (box) {
        box.addEventListener("click", function (e) {
            const adminUrl = this.getAttribute("data-admin-url");
            if (!adminUrl) return; // Only do this for admins

            // Donâ€™t trigger if user clicked inside input or button
            if (e.target.closest("input") || e.target.closest("button") || e.target.closest("a")) {
                return;
            }

            window.location.href = adminUrl;
        });
    });
});
</script>
<style>
@keyframes flashGreen {
  0%   { background-color: #34d399; }
  100% { background-color: inherit; }
}

.flash-green {
  animation: flashGreen 1.2s ease-in-out;
}

</style>
{% endblock %}

{% block main %}
<div class="challenge-container">
    <!-- Leaderboard -->
    <div id="hoco-scores">
        <div class="score-box">
            <div class="class">{{ data.0.0 }}</div>
            <div class="corner-ribbon"></div>
            <div class="score" id="score-senior">{{ data.0.1 }}</div>
            points
        </div>
        <div class="score-box">
            <div class="class">{{ data.1.0 }}</div>
            <div class="corner-ribbon"></div>
            <div class="score" id="score-junior">{{ data.1.1 }}</div>
            points
        </div>
        <div class="score-box">
            <div class="class">{{ data.2.0 }}</div>
            <div class="corner-ribbon"></div>
            <div class="score" id="score-sophomore">{{ data.2.1 }}</div>
            points
        </div>
        <div class="score-box">
            <div class="class">{{ data.3.0 }}</div>
            <div class="corner-ribbon"></div>
            <div class="score" id="score-freshman">{{ data.3.1 }}</div>
            points
        </div>
    </div>

    <!-- Page Title -->
    <h1 class="page-title">Homecoming Scavenger Hunt {{ HUNT_YEAR }}</h1>

    <!-- Categories and Challenges -->
    {% for category, challenges in categories.values %}
    <div class="category-section">
        <div class="category-header">
            <h2 class="category-title">{{ category.name }}</h2>
            <button class="toggle-btn" 
                onclick="document.getElementById('c-{{ category.id }}').style.display = document.getElementById('c-{{ category.id }}').style.display === 'none' ? 'grid' : 'none'">
                Toggle
            </button>
        </div>
        
        {% if category.description %}
        <p class="category-description">{{ category.description }}</p>
        {% endif %}
        
        <div id="c-{{ category.id }}" class="challenges-grid">
            {% for challenge, status in challenges.items %}
            {% if status.0.unblocked %}
            <div id="box{{ status.0.id }}" class="challenge-box {% if status.1 == 'available' %}available{% elif status.1 == 'completed' %}completed{% else %}locked{% endif %}{% if request.user.is_staff %} admin-clickable{% endif %}"
                {% if request.user.is_staff %}
                    data-admin-url="{% url 'admin:main_challenge_change' status.0.id %}"
                    title="Edit this challenge"
                    style="cursor: pointer;" 
                    onmouseover="this.style.boxShadow='0 0 10px rgba(0,0,0,0.2)'; this.style.borderColor='#3498db';"
                    onmouseout="this.style.boxShadow=''; this.style.borderColor='';"
                {% endif %}>
                <div class="challenge-header">
                    <h4 class="challenge-title">{{ status.0.name }}</h4>
                    {% if status.0.is_decreasing and status.1 == 'available' and status|length > 2 %}
                        <p class="challenge-points">{{ status.2 }} points</p>
                    {% else %}
                        <p class="challenge-points">{{ status.0.points }} points</p>
                    {% endif %}
                </div>
                
                <div class="challenge-content">
                    {% if status.1 == 'completed' %}
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                        <div class="challenge-status-text completed">Solved!</div>
                    {% elif status.1 == 'locked' %}
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                        <p class="challenge-description">This challenge was exclusive and has already been completed by another class.</p>
                    {% elif status.0.is_exclusive %}
                        <p class="challenge-description">This challenge's points are only available to the first class to complete it.</p>
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                    {% elif status.0.is_decreasing %}
                        <p class="challenge-description">This challenge's points decrease each time a class completes it.</p>
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                    {% else %}
                        <p class="challenge-description">{{ status.0.short_description|linkify }}</p>
                    {% endif %}
                </div>
                
                {% if status.1 == 'available' %}
                <div class="challenge-input">
                    <input type="text" id="{{ status.0.id }}" class="flag-input" placeholder="Enter the flag here" />
                    <button type="button" class="submit-btn" onclick="checkFlag({{ status.0.id }})">Submit</button>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div id="box{{ status.0.id }}" class="challenge-box locked{% if request.user.is_staff %} admin-clickable{% endif %}"
                {% if request.user.is_staff %}
                    data-admin-url="{% url 'admin:main_challenge_change' status.0.id %}"
                    title="Edit this challenge"
                    style="cursor: pointer;" 
                    onmouseover="this.style.boxShadow='0 0 10px rgba(0,0,0,0.2)'; this.style.borderColor='#3498db';"
                    onmouseout="this.style.boxShadow=''; this.style.borderColor='';"
                {% endif %}>
                <div class="challenge-header">
                    <h4 class="challenge-title">{{ status.0.name }}</h4>
                    <p class="challenge-points">{{ status.0.points }} points</p>
                </div>
                <div class="challenge-content">
                    <p class="challenge-description">This challenge is currently unavailable.</p>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}
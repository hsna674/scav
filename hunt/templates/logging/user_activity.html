{% extends "base_with_nav.html" %}

{% block title %}{{ profile_user.username }} - Activity{% endblock %}

{% block main %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>{{ profile_user.username }}'s Activity</h1>
            <p class="text-muted">{{ profile_user.get_full_name }} - Class of {{ profile_user.graduation_year }}</p>
        </div>
    </div>

    <!-- User Stats -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ stats.total_activities }}</h3>
                    <small class="text-muted">Total Activities</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ stats.total_submissions }}</h3>
                    <small class="text-muted">Flag Submissions</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ stats.correct_submissions }}</h3>
                    <small class="text-muted">Correct Flags</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ stats.total_completions }}</h3>
                    <small class="text-muted">Completions</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ stats.total_points }}</h3>
                    <small class="text-muted">Points Earned</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger">{{ stats.success_rate }}%</h3>
                    <small class="text-muted">Success Rate</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Flag Submissions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Flag Submissions</h5>
                </div>
                <div class="card-body">
                    {% for submission in flag_submissions %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                        <div>
                            <strong>{{ submission.challenge.name }}</strong>
                            <br>
                            <small class="text-muted">{{ submission.timestamp|date:"M d, H:i" }}</small>
                        </div>
                        <div class="text-right">
                            {% if submission.invalidated %}
                            <span class="badge badge-warning">⚠ Invalidated</span>
                            {% elif submission.is_correct %}
                            <span class="badge badge-success">✓</span>
                            {% if submission.points_awarded > 0 %}
                            <span class="badge badge-primary">{{ submission.points_awarded }} pts</span>
                            {% endif %}
                            {% else %}
                            <span class="badge badge-danger">✗</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No flag submissions yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Challenge Completions</h5>
                </div>
                <div class="card-body">
                    {% for completion in completions %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom" id="completion-{{ completion.id }}">
                        <div>
                            <strong>{{ completion.challenge.name }}</strong>
                            <br>
                            <small class="text-muted">{{ completion.timestamp|date:"M d, H:i" }}</small>
                            {% if completion.first_completion_for_class %}
                            <span class="badge badge-warning">First for class!</span>
                            {% endif %}
                        </div>
                        <div>
                            <span class="badge badge-primary">{{ completion.points_earned }} pts</span>
                            {% if completion.flag_submission_id %}
                            <button class="btn btn-sm btn-danger ml-2" onclick="invalidateSubmission({{ completion.flag_submission_id }}, {{ completion.id }})">
                                Invalidate
                            </button>
                            {% else %}
                            <small class="text-muted">No valid submission</small>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No completions yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- All Activities -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>All Activities</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Activity Type</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in page_obj %}
                                <tr>
                                    <td>{{ activity.timestamp|date:"M d, H:i:s" }}</td>
                                    <td>
                                        <span class="badge badge-secondary">{{ activity.get_activity_type_display }}</span>
                                    </td>
                                    <td>
                                        {% if activity.details %}
                                        <small class="text-muted">
                                            {% if activity.details.challenge_name %}
                                            Challenge: {{ activity.details.challenge_name }}
                                            {% endif %}
                                            {% if activity.details.points_awarded %}
                                            - {{ activity.details.points_awarded }} points
                                            {% endif %}
                                            {% if activity.details.path %}
                                            Page: {{ activity.details.path }}
                                            {% endif %}
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td><small class="text-muted">{{ activity.ip_address }}</small></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No activities found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                            </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                            </li>
                            
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Set dark mode class on body
$(document).ready(function() {
    {% if dark_mode %}
        document.body.classList.add('dark-mode');
        
        // Force refresh styles for cards
        setTimeout(function() {
            $('.card').each(function() {
                $(this).addClass('dark-mode-card');
            });
        }, 100);
    {% endif %}
});
</script>



<script>
function invalidateSubmission(submissionId, completionId) {
    if (!confirm('Are you sure you want to invalidate this completion? This will mark the flag submission as invalid and remove the points from the user and class. The submission record will be preserved for audit purposes.')) {
        return;
    }
    
    fetch(`{% url 'logging:invalidate_submission' 0 %}`.replace('0', submissionId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the completion from the UI since completion records are deleted
            const completionDiv = document.getElementById(`completion-${completionId}`);
            if (completionDiv) {
                // Add fade-out animation
                completionDiv.style.transition = 'opacity 0.3s ease-out';
                completionDiv.style.opacity = '0';
                
                // Remove after animation
                setTimeout(() => {
                    completionDiv.remove();
                    
                    // Check if completions section is now empty
                    const completionsContainer = completionDiv.parentNode;
                    if (completionsContainer && completionsContainer.children.length === 0) {
                        completionsContainer.innerHTML = '<p class="text-muted">No completions yet</p>';
                    }
                }, 300);
            }
            
            alert(data.message + ' The invalidated flag submission can still be seen in the Flag Submissions section below.');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while invalidating the submission.');
    });
}

// Set dark mode class on body
$(document).ready(function() {
    {% if dark_mode %}
        document.body.classList.add('dark-mode');
        
        // Force refresh styles for cards
        setTimeout(function() {
            $('.card').each(function() {
                $(this).removeClass('dark-mode').addClass('dark-mode');
            });
        }, 100);
    {% endif %}
});
</script>
{% endblock %}
